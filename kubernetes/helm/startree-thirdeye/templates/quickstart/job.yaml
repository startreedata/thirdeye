#
# Copyright 2022 StarTree Inc
#
# Licensed under the StarTree Community License (the "License"); you may not use
# this file except in compliance with the License. You may obtain a copy of the
# License at http://www.startree.ai/legal/startree-community-license
#
# Unless required by applicable law or agreed to in writing, software distributed under the
# License is distributed on an "AS IS" BASIS, WITHOUT * WARRANTIES OF ANY KIND,
# either express or implied.
# See the License for the specific language governing permissions and limitations under
# the License.
#


{{- if .Values.quickstart.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: quickstart-datasets
spec:
  template:
    metadata:
      name: quickstart-datasets
    spec:
      initContainers:
      - name: wait-for-pinot
        image: alpine/curl:latest
        env:
          - name: CONTROLLER_PROTOCOL
            value: {{ (.Values.quickstart.pinot).controllerProtocol | default "http" | quote }}
          - name: CONTROLLER_HOST
            value: {{ (.Values.quickstart.pinot).controllerHost | default "pinot-pinot-controller-headless" | quote }}
          - name: CONTROLLER_PORT
            value: {{ (.Values.quickstart.pinot).controllerPort | default "9000" | quote }}
        command: ['sh', '-c', 'until curl -f $CONTROLLER_PROTOCOL://$CONTROLLER_HOST:$CONTROLLER_PORT/health; do echo waiting for pinot; sleep 2; done']
      containers:
      - name: load-datasets
        image: apachepinot/pinot:latest-jdk11
        command: ["/quickstart/resources/quickstart.sh"]
        volumeMounts:
        - name: quickstart-resources
          mountPath: /quickstart/resources/
        env:
          - name: JAVA_OPTS
            value: "-Xms256M -Xmx1G -XX:+UseG1GC -Dlog4j2.configurationFile=conf/log4j2.xml -Dpinot.admin.system.exit=true"
          - name: CONTROLLER_PROTOCOL
            value: {{ (.Values.quickstart.pinot).controllerProtocol | default "http" | quote }}
          - name: CONTROLLER_HOST
            value: {{ (.Values.quickstart.pinot).controllerHost | default "pinot-pinot-controller-headless" | quote }}
          - name: CONTROLLER_PORT
            value: {{ (.Values.quickstart.pinot).controllerPort | default "9000" | quote }}
      volumes:
        - name: quickstart-resources
          configMap:
            name: quickstart-scripts
            defaultMode: 0777
      restartPolicy: Never
{{- end }}
