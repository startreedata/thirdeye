#
# Copyright 2022 StarTree Inc
#
# Licensed under the StarTree Community License (the "License"); you may not use
# this file except in compliance with the License. You may obtain a copy of the
# License at http://www.startree.ai/legal/startree-community-license
#
# Unless required by applicable law or agreed to in writing, software distributed under the
# License is distributed on an "AS IS" BASIS, WITHOUT * WARRANTIES OF ANY KIND,
# either express or implied.
# See the License for the specific language governing permissions and limitations under
# the License.
#

version: '3.9'

services:
  ui:
    image: ${DOCKER_REGISTRY_URL}thirdeye-ui:latest
    ports:
      - "7005:8081"
    environment:
      NGINX_PORT: 8081
      THIRDEYE_API_BASE_URL: "http://coordinator:8080"
      DNS_RESOLVER: "127.0.0.11"
    depends_on:
      coordinator:
        condition: service_healthy

  coordinator:
    image: ${DOCKER_REGISTRY_URL}thirdeye:latest
    ports:
      - "7004:8080"
      - "7003:8090"
    volumes:
      - ./resources/server.yaml:/home/thirdeye/thirdeye/config/server.yaml
    command: server
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget" , "http://localhost:8080" ]
      timeout: 15s
      retries: 10

  db:
    image: mysql:8.0.28
    ports:
      - "7002:3306"
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: thirdeye_test
      MYSQL_USER: uthirdeye
      MYSQL_PASSWORD: pass
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      timeout: 15s
      retries: 10

  pinot:
    image: apachepinot/pinot:latest
    ports:
      - "9000:9000"
      - "8000:8000"
    command: QuickStart -type batch
    healthcheck:
      test: [ "CMD", "wget", "http://localhost:8000/health" ]
      timeout: 15s
      retries: 10

  dataloader:
    image: apachepinot/pinot:latest
    volumes:
      - ../../examples:/home/thirdeye/examples
      - ./resources:/home/thirdeye/resources
    environment:
      DATASET: order_events
    working_dir: /home/thirdeye
    entrypoint: ["sh", "resources/thirdeye-quickstart-pinot.sh"]
    depends_on:
      pinot:
        condition: service_healthy

  entityloader:
    image: curlimages/curl
    volumes:
      - ./resources:/home/thirdeye/resources
    environment:
      DATASET: order_events
    working_dir: /home/thirdeye
    entrypoint: [ "sh", "resources/thirdeye-quickstart.sh" ]
    depends_on:
      coordinator:
        condition: service_healthy
